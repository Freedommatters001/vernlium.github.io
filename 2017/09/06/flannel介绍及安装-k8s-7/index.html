<!DOCTYPE html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="docker,k8s,flannel," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="flannel简介flannel安装流程1·下载flannel安装包https://github.com/coreos/flanneI/releases/tag/v0.7.1将下载的安装包解压，将其中的flannel拷贝到/usr/local/bin/目录下。 安装etcdctl将etcd中的etcdctl可执行二进制文件拷贝到/usr/local/bin目录下。 2·配置文件新建文件/etc/d">
<meta name="keywords" content="docker,k8s,flannel">
<meta property="og:type" content="article">
<meta property="og:title" content="flannel介绍及安装-k8s_7">
<meta property="og:url" content="://vernlium.github.io/2017/09/06/flannel介绍及安装-k8s-7/index.html">
<meta property="og:site_name" content="AnanZhang">
<meta property="og:description" content="flannel简介flannel安装流程1·下载flannel安装包https://github.com/coreos/flanneI/releases/tag/v0.7.1将下载的安装包解压，将其中的flannel拷贝到/usr/local/bin/目录下。 安装etcdctl将etcd中的etcdctl可执行二进制文件拷贝到/usr/local/bin目录下。 2·配置文件新建文件/etc/d">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://user-images.githubusercontent.com/11350907/30549280-f3a39ee6-9cc6-11e7-96bf-3872bba098c9.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/11350907/30548777-a060a9a0-9cc5-11e7-8e28-f0b62d60aa96.png">
<meta property="og:updated_time" content="2017-09-20T23:27:41.296Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="flannel介绍及安装-k8s_7">
<meta name="twitter:description" content="flannel简介flannel安装流程1·下载flannel安装包https://github.com/coreos/flanneI/releases/tag/v0.7.1将下载的安装包解压，将其中的flannel拷贝到/usr/local/bin/目录下。 安装etcdctl将etcd中的etcdctl可执行二进制文件拷贝到/usr/local/bin目录下。 2·配置文件新建文件/etc/d">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/11350907/30549280-f3a39ee6-9cc6-11e7-96bf-3872bba098c9.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="://vernlium.github.io/2017/09/06/flannel介绍及安装-k8s-7/"/>





  <title>flannel介绍及安装-k8s_7 | AnanZhang</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AnanZhang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Keep codeing and thinking!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="://vernlium.github.io/2017/09/06/flannel介绍及安装-k8s-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张阿楠">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/wukong.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AnanZhang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">flannel介绍及安装-k8s_7</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-06T23:04:12+08:00">
                2017-09-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="flannel简介"><a href="#flannel简介" class="headerlink" title="flannel简介"></a>flannel简介</h3><h3 id="flannel安装流程"><a href="#flannel安装流程" class="headerlink" title="flannel安装流程"></a>flannel安装流程</h3><h4 id="1·下载flannel安装包"><a href="#1·下载flannel安装包" class="headerlink" title="1·下载flannel安装包"></a>1·下载flannel安装包</h4><p><a href="https://github.com/coreos/flanneI/releases/tag/v0.7.1" target="_blank" rel="external">https://github.com/coreos/flanneI/releases/tag/v0.7.1</a><br>将下载的安装包解压，将其中的flannel拷贝到/usr/local/bin/目录下。</p>
<h5 id="安装etcdctl"><a href="#安装etcdctl" class="headerlink" title="安装etcdctl"></a>安装etcdctl</h5><p>将etcd中的etcdctl可执行二进制文件拷贝到/usr/local/bin目录下。</p>
<h4 id="2·配置文件"><a href="#2·配置文件" class="headerlink" title="2·配置文件"></a>2·配置文件</h4><p>新建文件/etc/default/flanneld，其内容为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FLANNELD_OPTS=&quot;--etcd-endpoints=http://192.168.0.2:2379,http://192.168.0.2:2379,http://192.168.0.2:2379&quot;</div></pre></td></tr></table></figure>
<p>编写flannel的upstart脚本，新建文件/etc/init/flanneld.conf，其内容为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">description &quot;flanneld service&quot;</div><div class="line"></div><div class="line">respawn </div><div class="line"></div><div class="line">start on (net-device-up </div><div class="line">    and local-filesystems </div><div class="line">    and runlevel [2345])</div><div class="line"></div><div class="line">stop on runlevel [ !2345])</div><div class="line"></div><div class="line">pre-start script </div><div class="line">    FLANNELD=/usr/IocaI/bin/$UPSTART_JOB</div><div class="line">    if [ -f $FLANNELD ]; then </div><div class="line">        exit 0</div><div class="line">    fi </div><div class="line">    exit 22 </div><div class="line">end script </div><div class="line"></div><div class="line">script </div><div class="line">    FLANNELD=/usr/locaI/bin/$UPSTART_JOB</div><div class="line">    FLANNELD_OPTS=&quot;&quot; </div><div class="line">    if [ -f /etc/defauIt/$UPSTART_JOB ]; then </div><div class="line">        · /etc/default/$UPSTART_JOB</div><div class="line">    fi </div><div class="line">    export HOME:/root </div><div class="line">    exec &quot;$FLANNELD&quot; $FLANNELD_OPTS </div><div class="line">end script</div></pre></td></tr></table></figure>
<h4 id="3-flannel配置信息写入etcd"><a href="#3-flannel配置信息写入etcd" class="headerlink" title="3.flannel配置信息写入etcd"></a>3.flannel配置信息写入etcd</h4><p>flannel的配置信息全部在etcd里面记录，往etcd里面写入下面这个最简单的配置，只指定flannel能用来分配给每个Docker节点的拟IP地址段:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">etcdctl --endpoints http://192.168.0.2:2379,http://192.168.0.2:2379,http://192.168.0.2:2379 \ </div><div class="line">set /coreos.com/network/config \</div><div class="line">&apos;&#123;&quot;Network&quot;: &quot;172.100.0.0/16,&quot;SubnetLen&quot;: 28,&quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&apos;</div></pre></td></tr></table></figure>
<p>其中<code>{&quot;Network&quot;: &quot;172.100.0.0/16,&quot;SubnetLen&quot;: 28,&quot;Backend&quot;: {&quot;Type&quot;: &quot;vxlan&quot;}}</code>配置中各字段的含义如下：</p>
<ul>
<li>Network (string): IPv4 network in CIDR format to use for the entire flannel network. (This is the only mandatory key.)<strong>必选字段</strong></li>
<li>SubnetLen (integer): The size of the subnet allocated to each host. Defaults to 24 (i.e. /24) unless Network was configured to be smaller than a /24 in which case it is one less than the network.<strong>可选</strong></li>
<li>Backend (dictionary): Type of backend to use and specific configurations for that backend. The list of available backends and the keys that can be put into the this dictionary are listed below. Defaults to udp backend.<strong>可选</strong><ul>
<li>Backeng的Type字段有如下几种选择：<ul>
<li>vxlan</li>
<li>host-gw</li>
<li>udp</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>我们配置的<code>&quot;Network&quot;:&quot;172.100.0.0/16&quot;,&quot;SubnetLen&quot;:28</code>含义为：</p>
<p>flannel集群（包含k8s master和node）的所有节点以及节点上的容器的ip都在<code>172.100.0.0/16</code>子网内。</p>
<p>子网长度28表示每个node节点上的子网长度，即每个node上也有一个小的子网，这个子网最多可支持2^（32-28）- 1=2^4 - 1=15个容器（-1是因为docker0网桥占了一个ip）<br>这个flannel集群最多支持2^（28-16）=2^12=4096个节点。</p>
<p>这个子网长度根据自己的场景来选择，例如项目的使用场景，每个node上容器个数少，node节点多，所以长度长一些。如果节点多，节点上的容器也多，可以将上面设置的<code>172.100.0.0/16</code>其中的16变小，子网的容量更大一些。</p>
<p>还有两个字段这里没有使用:</p>
<ul>
<li>SubnetMin (string): The beginning of IP range which the subnet allocation should start with. Defaults to the first subnet of Network.<strong>可选</strong></li>
<li>SubnetMax (string): The end of the IP range at which the subnet allocation should end with. Defaults to the last subnet of Network.<strong>可选</strong></li>
</ul>
<h3 id="4-flannel的启动"><a href="#4-flannel的启动" class="headerlink" title="4.flannel的启动"></a>4.flannel的启动</h3><p><code>start flanneld</code>命令启动flanneld。</p>
<p>启动成功后，会新增一个文件<code>/run/flannel/subnet.env</code>，查看其中的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">FLANNEL_NETWORK=172.100.0.0/16 </div><div class="line">FLANNEL_SUBNET=172.100.4.49/28 </div><div class="line">FLANNEL_MTU=1450</div><div class="line">FLANNEL_IPMASQ=false</div></pre></td></tr></table></figure>
<p>这个是flanneld进程从etcd上拉取到的配置写入到本地文件中。</p>
<p>其中:</p>
<ul>
<li>FLANNEL_NETWORK: flannel的网络地址</li>
<li>FLANNEL_SUBNET: 本节点上的子网网段 </li>
<li>FLANNEL_MTU: 最大传输单元大小</li>
<li>FLANNEL_IPMASQ: 是否开启IPMASQ防火墙</li>
</ul>
<p>5· 重 启 docker </p>
<p>将 /run/flannel/subnet.env 文 件 中 的 内 容 加 入 到 docker 启 动 的 配 置 项 中<br>`–bip=${FLANNEL_SUBNET} –mtu=${FLANNEL_MTU}。然后重启docker0 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">root@LFG1000826665:~# stop docker </div><div class="line">root@LFG1000826665:~# cat /run/flannel/subnet.env </div><div class="line">FLANNEL_NETWORK=172.100.0.0/16 </div><div class="line">FLANNEL_SUBNET=172.100.32.1/28 </div><div class="line">FLANNEL_MTU=1450 </div><div class="line">FLANNEL_IPMASQ=false</div><div class="line">root@LFG1000826665:~# cat /etc/default/docker </div><div class="line">DOCKER_OPTS=&quot;$DOCKER_OPTS -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375 -bip=172.100.4.49/28 --mtu=1450&quot; </div><div class="line">DOCKER_CERT_PATH=&quot;/etc/docker&quot; </div><div class="line">root@LFG1000826665:~#</div><div class="line">root@LFG1000826665:~# start docker </div><div class="line">root@LFG1000826665:~# ps ex 丨 grep dockerd </div><div class="line">1039 ? Ssl 1:13 /usr/bin/dockerd -H unix:///var/run/docker.sock -H  tcp://0.0.0.0:2375 -bip=172.100.4.49/28 --mtu=1450</div></pre></td></tr></table></figure>
<p>注:我们用的系统是ubuntu14.04，使用upstart来启动服务。将配置项写入到<code>/etc/default/docker</code>文件中，启动服务时会upstart脚本会读取此文件。</p>
<h3 id="6·安装结果"><a href="#6·安装结果" class="headerlink" title="6·安装结果"></a>6·安装结果</h3><p>上述步骤执行完成后，在任意一个node上可以看一下网络配置 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">root@LFG1000826665:~# ifconfig </div><div class="line">dockerO Link encap:Ethernet HWaddr 02:42:cb:44:b0:50 </div><div class="line">	inet addr:172.100.4.49 Bcast:0.0.0.0 Mask:255.255.255.240 </div><div class="line">	inet6 addr:fe80::42:cbf:fe44:b050/64 Scope:Link </div><div class="line">	UP BROADCAST RUNNING MULTICAST MTU:1450 Metric:1</div><div class="line">	RX packets:248 errors:0 dropped:0 overruns:0 frame:0 </div><div class="line">	TX packets:291 errors:0 dropped:0 overruns:0 carrier:0 </div><div class="line">	collisions:0 txqueuelen:0 </div><div class="line">	RX bytes:36349(36.3 KB) TX bytes:38066 (38.0 KB) </div><div class="line">	 </div><div class="line">eth0 Link encap:Ethernet HWaddr 28:6e:d4:89:35:ad </div><div class="line">	inet addr:100.120.45.93 Bcast:100.120.45.255 Mask:255.255.254.0</div><div class="line">	inet6 add fe80:2a6e:d4ff:fe89:35ad/64 Scope Link </div><div class="line">	UP BROADCAST RUNNING M ULTICAST MTU:1500 Metric:1 </div><div class="line">	RX packets:53074 errors:0 dropped:0 overruns:0 frame:0 </div><div class="line">	TX packets:9571 errors:0 dropped:0 overruns:0 carrier:0 </div><div class="line">	collisions:0 txqueuelen:1000 </div><div class="line">	RX bytes:7036582(7.0 MB) TX b es:3556172(3.5 MB) </div><div class="line"></div><div class="line">flannel.l Link encap:Ethernet HWaddr da:05B6:6a:01:ad </div><div class="line">	inet addr:172.100.4.48 Bcast:0.0.0.0 Mask:255.255.255.255 </div><div class="line">	inet6 addr:fe80:d805:36ff:fe6a:1ad/64 Scope:Link </div><div class="line">	UP BROADCAST RUNNING MULTICAST MTU:1450 Metric:1 </div><div class="line">	RX packets:33 errors:0 dropped:0 overruns:0 frame:0 </div><div class="line">	TX packets:33 errors:0 dropped:9 overruns:0 carrier:0 </div><div class="line">	collisions:0 txqueuelen:0</div><div class="line">	RX bytes:2604(2.6 KB) TX bytes:3594(3.5 KB)</div></pre></td></tr></table></figure>
<p>可以看到有一个flannel.l的网桥，doker0网桥的网段在我们配置的网络内。</p>
<p>安装多个节点后，可以看一下etcd中<code>/sandbox/network</code>中的信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">root@LFG1000826665:~# etcdctl --endpoints=http://100.120.76.244:2379,http://100.120.77.15:2379,http://100.120.109.1:2379 get /sandbox/network/config </div><div class="line">&#123; &quot;Network&quot;:&quot;172.100.0.0/16&quot;,&quot;SubnetLen&quot;:28,&quot;Backend&quot;: &#123;&quot;Type&quot;:&quot;vxlan&quot;&#125;&#125; </div><div class="line">root@LFG1000826665:~#</div><div class="line">root@LFG1000826665:~# etcdctl --endpoints=http://100.120.76.244:2379,http://100.120.77.15:2379,http://100.120.109.1:2379 ls /sandbox/network/subnets </div><div class="line">/sandbox/network/subnets/172.100.0.208-28 </div><div class="line">/sandbox/network/subnets/172.100.5.0-28 </div><div class="line">/sandbox/network/subnets/172.100.0.240-28 </div><div class="line">/sandbox/network/subnets/172.100.0.96-28 </div><div class="line">/sandbox/network/subnets/172.100.2.208-28 </div><div class="line">/sandbox/network/subnets/172.100.3.48-28 </div><div class="line">/sandbox/network/subnets/172.100.4.48-28 </div><div class="line">/sandbox/network/subnets/172.100.5.144-28 </div><div class="line">/sandbox/network/subnets/172.100.5.48-28 </div><div class="line"></div><div class="line">root@LFG1000826665:~# etcdctl --endpoints=http://100.120.76.244:2379,http://100.120.77.15:2379,http://100.120.109.1:2379 get /sandbox/network/subnets/172.100.4.48-28</div><div class="line">&#123;&quot;PublicIP&quot;:100.120.45.93&quot;,&quot;BackendTypen&quot;:&quot;vxlan&quot;,&quot;BackendData&quot;:&#123;&quot;VtepMAC&quot;:&quot;da:05:36:6a:01:ad&quot;&#125;&#125;</div></pre></td></tr></table></figure>
<p>可以看到<code>/sandbox/network</code>路径下多了一个subnets路径，有很多子节点，这些节点正好对应flannel集群中的9个节点，<br>flannel会给每个节点分配一个网段，并记录在etcd中。</p>
<p>可以看到，<code>172.100.4.48-28</code>网段分配给的节点是100.120.45.93，也就是我们上面ifconfig看到的那个节点。</p>
<h3 id="容器互通"><a href="#容器互通" class="headerlink" title="容器互通"></a>容器互通</h3><p>在k8s集群中部署几个容器（任意分布的不同或相同的节点），然后进入容器内查看ip，并在不同沙箱之间互相ping，可以发<br>现，任意两个沙箱都能互相ping通.</p>
<table>
<thead>
<tr>
<th>客器名</th>
<th>所在节点</th>
<th>客器ip</th>
<th>所在子网</th>
</tr>
</thead>
<tbody>
<tr>
<td>bizflannel01</td>
<td>100.120.93.1</td>
<td>172.100.5.2</td>
<td>172.100.5.0/28</td>
</tr>
<tr>
<td>bizflannel02</td>
<td>100.120.79.159</td>
<td>172.100.2.210</td>
<td>172.100.2.208/28</td>
</tr>
<tr>
<td>bizflannel03</td>
<td>100.120.45.93</td>
<td>172.100.4.50</td>
<td>172.100.4.48/28</td>
</tr>
<tr>
<td>bizflannel04</td>
<td>100.120.93.1</td>
<td>172.100.5.3</td>
<td>172.100.5.0/28</td>
</tr>
</tbody>
</table>
<p>我们在bizflanne104中ping其他容器，发现都可以Ping通：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">bizflannel4:/ # ping 172.100.5.2 </div><div class="line">PING 172.100.5.2 (172.100.5.2) 56(84) bytes of data. </div><div class="line">64 bytes from 172.100.5.2: icmp_seq=1 ttl=64 time=0.118 ms</div><div class="line">64 bytes from 172.100.5.2: icmp_seq=2 ttl=64 time=0.068 ms</div><div class="line">^C</div><div class="line">--- 172.100.5.2 ping statistics ---</div><div class="line">2 packets transmitted, 2 received, 0% packet loss, time 999ms</div><div class="line">rtt min/avg/max/mdev = 0.068/0.093/0.118/0.025 ms </div><div class="line">bizflannel4:/ #</div><div class="line">bizflannel4:/ # ping 172.100.4.50</div><div class="line">PING 172.100.5.2 (172.100.4.50) 56(84) bytes of data. </div><div class="line">64 bytes from 172.100.4.50: icmp_seq=1 ttl=64 time=2.19 ms</div><div class="line">64 bytes from 172.100.4.50: icmp_seq=2 ttl=64 time=0.463 ms</div><div class="line">^C</div><div class="line">--- 172.100.4.50 ping statistics ---</div><div class="line">2 packets transmitted, 2 received, 0% packet loss, time 999ms</div><div class="line">rtt min/avg/max/mdev = 0.463/1.330/2.198/0.868 ms </div><div class="line">bizflannel4:/ #</div><div class="line">bizflannel4:/ # ping 172.100.2.210 </div><div class="line">PING 172.100.5.2 (172.100.5.2) 56(84) bytes of data. </div><div class="line">64 bytes from 172.100.2.210: icmp_seq=1 ttl=64 time=1.54 ms</div><div class="line">64 bytes from 172.100.2.210: icmp_seq=2 ttl=64 time=0.520 ms</div><div class="line">64 bytes from 172.100.2.210: icmp_seq=3 ttl=64 time=0.396 ms</div><div class="line">^C</div><div class="line">--- 172.100.2.210 ping statistics ---</div><div class="line">3 packets transmitted, 3 received, 0% packet loss, time 999ms</div><div class="line">rtt min/avg/max/mdev = 0.396/0.820/1.544/0.514 ms </div><div class="line">bizflannel4:/ #</div></pre></td></tr></table></figure>
<p>通过tcpdump命令抓包，可以看到包的内部含有小网ip，正如flannel网络示意图中展示的那样。</p>
<p>从bizflanne104中<code>ping 172.100.4.50</code>的同时，在<code>100.120.45.93</code>上抓取从<code>100.120.93.144</code>来的包。</p>
<p>抓包命令为<code>tcpdump -i eth0 src host 100.120.93.144</code>，结果如下</p>
<p><img src="https://user-images.githubusercontent.com/11350907/30549280-f3a39ee6-9cc6-11e7-96bf-3872bba098c9.png" alt="image"></p>
<h3 id="flannel网络示意图"><a href="#flannel网络示意图" class="headerlink" title="flannel网络示意图"></a>flannel网络示意图</h3><p><img src="https://user-images.githubusercontent.com/11350907/30548777-a060a9a0-9cc5-11e7-8e28-f0b62d60aa96.png" alt="image"></p>
<h4 id="一条网络报文是怎么从一个容器发送到另外一个容器的"><a href="#一条网络报文是怎么从一个容器发送到另外一个容器的" class="headerlink" title="一条网络报文是怎么从一个容器发送到另外一个容器的"></a>一条网络报文是怎么从一个容器发送到另外一个容器的</h4><ul>
<li>容器直接使用目标容器的ip访问，默认通过容器内部的eth0发送出去</li>
<li>报文通过vethpair被发送到vethXXX</li>
<li>vethXXX是直接连接到虚拟交换机dockerO的，报文通过虚拟bridge docker0发送出去</li>
<li>查找路由表，外部容器ip的报文都会转发到flannel0虚拟网卡，这是一个P2P的虚拟网卡（关于这一点的工<br>理，我也不是很清楚），然后报文就被转发到监听在另一端的flanneld</li>
<li>flanneld通过etcd维护了各个节点之间的路由表，把原来的报文UDP封装一层，通过配置的iface发送出</li>
<li>报文通过主机之间的网络找到目标主机</li>
<li>报文继续往上，到传输层，交给监听在8285端口的flanneld程序处理</li>
<li>数据被解包，然后发送给flannel0虚拟网卡</li>
<li>查找路由表，发现对应容器的报文要交给docker0</li>
<li>docker0找到连到自己的容器，把报文发送过去</li>
</ul>
<h4 id="一条网络报文是怎么从一个容器发送到外部网络"><a href="#一条网络报文是怎么从一个容器发送到外部网络" class="headerlink" title="一条网络报文是怎么从一个容器发送到外部网络"></a>一条网络报文是怎么从一个容器发送到外部网络</h4><ul>
<li>容器直接使用目标容器的ip访问，默认通过容器内部的eth0发送出去</li>
<li>报文通过veth pair被发送到vethXXX</li>
<li>vethXXX是直接连接到虚拟bridge docker0的，报文通过虚拟bridge docker0发送出去</li>
<li>查找路由表，外部网络ip的报文都会转发到eth()网卡</li>
<li>eth0发送报文时会匹印如下iptables规则：<br><code>-A POSTROUTING -s 172.100.9.16/28 ! -o docker0 -j MASQUERADE</code><br>这条规则的作用是将pod network地址伪装为node ip发出去，包回来时再将地址转换为容器的network地址</li>
<li>最终，这个请求会变成此node ip和外部网络的交互。</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/docker/" rel="tag"># docker</a>
          
            <a href="/tags/k8s/" rel="tag"># k8s</a>
          
            <a href="/tags/flannel/" rel="tag"># flannel</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/06/k8s实践-k8s-5/" rel="next" title="k8s实践-k8s_5">
                <i class="fa fa-chevron-left"></i> k8s实践-k8s_5
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/19/docker及kunbernetes网络-k8s-6/" rel="prev" title="docker及kunbernetes网络-k8s-6">
                docker及kunbernetes网络-k8s-6 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/wukong.png"
               alt="张阿楠" />
          <p class="site-author-name" itemprop="name">张阿楠</p>
           
              <p class="site-description motion-element" itemprop="description">Keep codeing and thinking!</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/vernlium" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/ananzhang" target="_blank" title="ZhiHu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      ZhiHu
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#flannel简介"><span class="nav-number">1.</span> <span class="nav-text">flannel简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flannel安装流程"><span class="nav-number">2.</span> <span class="nav-text">flannel安装流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1·下载flannel安装包"><span class="nav-number">2.1.</span> <span class="nav-text">1·下载flannel安装包</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#安装etcdctl"><span class="nav-number">2.1.1.</span> <span class="nav-text">安装etcdctl</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2·配置文件"><span class="nav-number">2.2.</span> <span class="nav-text">2·配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-flannel配置信息写入etcd"><span class="nav-number">2.3.</span> <span class="nav-text">3.flannel配置信息写入etcd</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-flannel的启动"><span class="nav-number">3.</span> <span class="nav-text">4.flannel的启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6·安装结果"><span class="nav-number">4.</span> <span class="nav-text">6·安装结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#容器互通"><span class="nav-number">5.</span> <span class="nav-text">容器互通</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flannel网络示意图"><span class="nav-number">6.</span> <span class="nav-text">flannel网络示意图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一条网络报文是怎么从一个容器发送到另外一个容器的"><span class="nav-number">6.1.</span> <span class="nav-text">一条网络报文是怎么从一个容器发送到另外一个容器的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#一条网络报文是怎么从一个容器发送到外部网络"><span class="nav-number">6.2.</span> <span class="nav-text">一条网络报文是怎么从一个容器发送到外部网络</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张阿楠</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
